<div class="post-detail-container">
  <!-- Loading State -->
  <div *ngIf="loading" class="loading-state">
    <div class="spinner"></div>
    <p>Loading post...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !loading" class="error-state">
    <h2>ğŸ˜• Post Not Found</h2>
    <p>{{ error }}</p>
    <button class="btn btn-primary" (click)="goBack()">Back to Home</button>
  </div>

  <!-- Post Content -->
  <div *ngIf="post && !loading" class="post-detail">
    <!-- Back Button -->
    <button class="back-btn" (click)="goBack()">â† Back to Posts</button>

    <!-- Post Header -->
    <header class="post-header">
      <div class="post-meta">
        <div class="author-info">
          <div class="author-avatar">
            <!-- <img
              [src]="post.author?.profilePicture || '/uploads/d318f3ca-dcf4-42e9-9241-946aa55514cd.png'"
              [alt]="post.author?.username"
            />  -->

            <!-- <img [src]="post.author?.profilePicture
    ? 'http://localhost:8080' + post.author.profilePicture
    : 'http://localhost:8080/uploads/d318f3ca-dcf4-42e9-9241-946aa55514cd.png'" [alt]="post.author?.username" /> -->
            <img [src]="getProfilePictureUrl()" alt="post.author?.username" class="avatar-large" />

            <!-- {{ post.author?.username }} -->

          </div>
          <div class="author-details">
            <h3 class="author-name">{{ post.author?.username || 'Unknown' }}</h3>
            <span class="post-date">{{ post.createdAt | date: 'MMMM d, yyyy' }}</span>
            <span class="read-time">â€¢ {{ calculateReadTime(post.content) }} min read</span>
          </div>
        </div>

        <div class="post-actions">
          <button class="action-btn" (click)="sharePost()" title="Share">ğŸ“¤ Share</button>
          <button class="action-btn" (click)="openInNewTab()" title="Open in new tab">
            â†—ï¸ New Tab
          </button>
          <button *ngIf="canEditPost() && !isEditing" class="action-btn edit-btn" (click)="startEditing()"
            title="Edit post">
            âœï¸ Edit
          </button>
          <button *ngIf="canDeletePost()" class="action-btn delete-btn" (click)="confirmDelete()" title="Delete post">
            ğŸ—‘ï¸ Delete
          </button>
        </div>
      </div>

      <h1 class="post-title" *ngIf="!isEditing">{{ post.title }}</h1>

      <div class="post-tags" *ngIf="!isEditing">
        <span *ngFor="let tag of post.tags" class="tag">{{ tag }}</span>
      </div>
    </header>

    <!-- Edit Form -->
    <div *ngIf="isEditing" class="edit-form">
      <h2>Edit Post</h2>
      <div class="form-group">
        <label for="edit-title">Title</label>
        <input id="edit-title" type="text" [(ngModel)]="editedTitle" class="form-control" placeholder="Post title" />
      </div>
      <div class="form-group">
        <label for="edit-content">Content</label>
        <textarea id="edit-content" [(ngModel)]="editedContent" class="form-control" rows="10"
          placeholder="Post content"></textarea>
      </div>
      <div class="edit-actions">
        <button (click)="saveEdit()" [disabled]="submittingEdit || !editedTitle.trim() || !editedContent.trim()"
          class="btn btn-primary">
          {{ submittingEdit ? 'Saving...' : 'Save Changes' }}
        </button>
        <button (click)="cancelEditing()" [disabled]="submittingEdit" class="btn btn-secondary">
          Cancel
        </button>
      </div>
    </div>

    <!-- Featured Media -->
    <div *ngIf="post.mediaUrl && !isEditing" class="featured-media">
      <img *ngIf="post.mediaType === 'image' || post.mediaType === 'gif'"
        [src]="'http://localhost:8080' + post.mediaUrl" [alt]="post.title" class="post-media" />
      <video *ngIf="post.mediaType === 'video'" [src]="'http://localhost:8080' + post.mediaUrl" controls
        class="post-video"></video>
    </div>

    <!-- Post Content -->
    <article class="post-content" *ngIf="!isEditing">
      <div [innerHTML]="formatContent(post.content)" class="content-text"></div>
    </article>

    <!-- Post Footer -->
    <footer class="post-footer">
      <div class="engagement-stats">
        <button class="like-btn" (click)="toggleLike()" [class.liked]="post.isLiked">
          <span class="like-icon">{{ post.isLiked ? 'â¤ï¸' : 'ğŸ¤' }}</span>
          <span class="like-count">{{ post.likeCount || 0 }} Likes</span>
        </button>

        <div class="comment-count">ğŸ’¬ {{ commentsTotal }} Comments</div>
        <div class="view-count">ğŸ‘ï¸ {{ post.viewCount || 0 }} Views</div>
      </div>

      <!-- Share Options -->
      <div class="share-options">
        <button class="share-btn twitter" (click)="shareOnTwitter()">ğŸ¦ Twitter</button>
        <button class="share-btn facebook" (click)="shareOnFacebook()">ğŸ“˜ Facebook</button>
        <button class="share-btn copy" (click)="copyPostLink()">ğŸ“‹ Copy Link</button>
        <button class="share-btn report">ğŸš© Report</button>
      </div>
    </footer>
    <!-- Comments Section -->
    <section class="comments-section">
      <h3>Comments ({{ commentsTotal }})</h3>

      <!-- Add Comment Form -->
      <div class="add-comment">
        <textarea [(ngModel)]="newComment" placeholder="Share your thoughts..." rows="3" class="comment-input">
    </textarea>
        <button (click)="addComment()" [disabled]="!newComment.trim() || submittingComment" class="submit-comment-btn">
          {{ submittingComment ? 'Posting...' : 'Post Comment' }}
        </button>
      </div>

      <!-- Comments List -->
      <div *ngIf="comments.length > 0" class="comments-list">
        <div *ngFor="let comment of comments" class="comment">
          <div class="comment-header">
            <div class="comment-author">
              <!-- Use only ONE img tag -->
              <img [src]="getUserProfilePicture(comment.author)" [alt]="comment.author?.username"
                class="comment-avatar" />
              <span class="comment-author-name">{{ comment.author?.username }}</span>
            </div>

            <div class="comment-actions">
              <span class="comment-date">{{ comment.createdAt | date: 'MMM d, yyyy' }}</span>
              <!-- Delete button is now INSIDE the *ngFor loop -->
              <button *ngIf="canDeleteComment(comment)" class="delete-comment-btn" (click)="deleteComment(comment.id)"
                title="Delete comment">
                ğŸ—‘ï¸
              </button>
            </div>
          </div>
          <p class="comment-text">{{ comment.content }}</p>
        </div>
      </div>

      <div *ngIf="commentsTotal === 0" class="no-comments">
        <p>No comments yet. Be the first to share your thoughts!</p>
      </div>

      <button class="load-more-comments"
        *ngIf="commentsCurrentPage + 1 < commentsTotalPages"
        (click)="loadMoreComments()">
        Load more comments
      </button>
    </section>


    <!-- Related Posts -->
    <section *ngIf="relatedPosts.length > 0" class="related-posts">
      <h3>More from {{ post.author?.username }}</h3>
      <div class="related-posts-grid">
        <div *ngFor="let relatedPost of relatedPosts" class="related-post-card">
          <h4 [routerLink]="['/post', relatedPost.id]" class="related-post-title">
            {{ relatedPost.title }}
          </h4>
          <p class="related-post-excerpt">{{ relatedPost.content | slice: 0 : 100 }}...</p>
        </div>
      </div>
    </section>
  </div>
</div>
